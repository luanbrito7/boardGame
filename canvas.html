<html>
    <head>
        <meta charset="utf-8">
        <title>Board Game</title>

        <style>
            #canvas {
                border: 2px solid lightcoral;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                image-rendering: -moz-crisp-edges;
                width: 800px;
                height: 600px;
            }
            .header {
                width: 804px;
                background-color: lightskyblue;
                display: flex;
                justify-content: center;
                padding-top: 25px;
                padding-bottom: 25px;
            }
            .button {
                width: 60px;
                height: 60px;
            }
            form {
                padding-left: 10px;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <button onclick="inputListener.rollDice()" class="button">
                <p>2</p>
            </button>
            <form onsubmit="return false">
                <label for="name">Player name:</label><br>
                <input type="text" id="target" name="playerTarget" value="">
            </form>
        </div>
        <canvas id="canvas" width="12" height="12"></canvas>
    </body>
    <script>
        const screen = document.getElementById('canvas')
        const context = screen.getContext('2d')
        let selfId = "p1"

        function gameFactory() {
            let state = {
                players: {
                    "p1": {x: 0, y: 0, name: "luan"},
                    "p2": {x: 1, y: 0, name: "oto"}
                },
                cards: [
                    {x: 3, y: 4},
                    {x: 6, y: 3},
                    {x: 1, y: 0},
                ]
            }

            function fillCards() {
                
            }

            function inputPlayer(command) {
                console.log(command)
                const acceptedInputs = {
                    rollDice(player) {
                        let diceValue = getRandomInt(1,6)
                        if (isVictorious(player, diceValue)) {
                            alert(`player ${player.name} won.`)
                        } else {
                            if (player.x + diceValue > 12) {
                                player.x = (diceValue + player.x) % 12
                                player.y += 1
                            } else {
                                player.x += diceValue
                            }
                        }
                        return null
                        function isVictorious(player, diceValue) {
                            if (player.x + diceValue > 12) {
                                if (player.y + 1 > 12) {
                                    return true
                                }
                            }
                            return false
                        }
                        function getRandomInt(min, max) {
                            min = Math.ceil(min);
                            max = Math.floor(max);
                            return Math.floor(Math.random() * (max - min)) + min;
                        }
                    },
                    attack(player) {

                    }
                }

                let player = state.players[command.playerId]
                let input = command.input
                let inputFuction = acceptedInputs[input]
                if (inputFuction && player) {
                    inputFuction(player)
                }
            }
            
            return {
                state,
                inputPlayer
            }
        }  
        const game = gameFactory()
        let inputListener = inputListenerFactory()
        inputListener.subscribe(game.inputPlayer) 
        function inputListenerFactory() {
            let observers = []

            function subscribe(observerFunction) {
                observers.push(observerFunction)
            }

            function notifyAll(command) {
                observers.forEach((observerFunction) => {
                    observerFunction(command)
                })
            }

            document.addEventListener("keydown", (event) => {
                let keyPressed = event.key
                console.log(keyPressed)
                let command = {
                    playerId: 'p1',
                    input: keyPressed
                }
                notifyAll(command)
            })

            function rollDice() {
                let command = {
                    playerId: 'p1',
                    input: 'rollDice'
                }
                notifyAll(command)
            }

            return {
                subscribe,
                rollDice
            }
        }
        renderElements()
        function renderElements() {
            context.fillStyle = "white"
            context.clearRect(0,0,12,12)
            for (var i = 0; i < 12; i++) {
                for (var j = 0; j < 12; j++) {
                    context.fillStyle = context.fillStyle == "#000000" ? "white" : "black"
                    context.fillRect(i, j, 1, 1);
                }
                context.fillStyle = context.fillStyle == "#000000" ? "white" : "black"
                context.fillRect(i, j, 1, 1);
            }
            for (playerKey in game.state.players) {
                    let player = game.state.players[playerKey]
                    context.fillStyle = 'green'
                    context.fillStyle = 'pink'
                    context.fillRect(player.x, player.y, 1, 1)
            }
            game.state.cards.forEach(card => {
                context.fillStyle = 'pink'
                context.fillRect(card.x, card.y, 1, 1)
            })
            requestAnimationFrame(renderElements)
        }
    </script>
</html>